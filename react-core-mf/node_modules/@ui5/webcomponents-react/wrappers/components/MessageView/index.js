'use client';

import iconSlimArrowLeft from '@ui5/webcomponents-icons/dist/slim-arrow-left.js';
import { useI18nBundle, useStylesheet, useSyncRef } from '@ui5/webcomponents-react-base';
import { clsx } from 'clsx';
import React, { Children, forwardRef, Fragment, isValidElement, useCallback, useEffect, useState } from 'react';
import { ButtonDesign, FlexBoxDirection, GlobalStyleClasses, TitleLevel, ValueState, WrappingType } from '../../enums/index.js';
import { ALL, LIST_NO_DATA } from '../../i18n/i18n-defaults.js';
import { MessageViewContext } from '../../internal/MessageViewContext.js';
import { Bar } from '../../webComponents/Bar/index.js';
import { Button } from '../../webComponents/Button/index.js';
import { GroupHeaderListItem } from '../../webComponents/GroupHeaderListItem/index.js';
import { Icon } from '../../webComponents/Icon/index.js';
import { List } from '../../webComponents/List/index.js';
import { SegmentedButton } from '../../webComponents/SegmentedButton/index.js';
import { SegmentedButtonItem } from '../../webComponents/SegmentedButtonItem/index.js';
import { Title } from '../../webComponents/Title/index.js';
import { FlexBox } from '../FlexBox/index.js';
import { classNames, styleData } from './MessageView.module.css.js';
import { getIconNameForType } from './utils.js';
export const resolveMessageTypes = children => {
  return (children ?? []).map(message => message?.props?.type).reduce((acc, type) => {
    const finalType = type === ValueState.None ? ValueState.Information : type;
    if (acc.hasOwnProperty(finalType)) {
      acc[finalType]++;
    }
    return acc;
  }, {
    [ValueState.Error]: 0,
    [ValueState.Warning]: 0,
    [ValueState.Success]: 0,
    [ValueState.Information]: 0
  });
};
export const resolveMessageGroups = children => {
  const groups = (children ?? []).reduce((acc, val) => {
    const groupName = val?.props?.groupName ?? '';
    if (acc.hasOwnProperty(groupName)) {
      acc[groupName].push(val);
    } else {
      acc[groupName] = [val];
    }
    return acc;
  }, {});
  return Object.entries(groups).sort((a, b) => {
    return a[0].localeCompare(b[0]);
  });
};

/**
 * The `MessageView` is used to display a summarized list of different types of messages (error, warning, success, and information messages).
 */
const MessageView = /*#__PURE__*/forwardRef((props, ref) => {
  const {
    children,
    groupItems,
    showDetailsPageHeader,
    className,
    onItemSelect,
    ...rest
  } = props;
  useStylesheet(styleData, MessageView.displayName);
  const [componentRef, internalRef] = useSyncRef(ref);
  const i18nBundle = useI18nBundle('@ui5/webcomponents-react');
  const [listFilter, setListFilter] = useState('All');
  const [selectedMessage, setSelectedMessage] = useState(null);
  const childrenArray = Children.toArray(children);
  const messageTypes = resolveMessageTypes(childrenArray);
  const filledTypes = Object.values(messageTypes).filter(count => count > 0).length;
  const filteredChildren = listFilter === 'All' ? childrenArray : childrenArray.filter(message => {
    if (! /*#__PURE__*/isValidElement(message)) {
      return false;
    }
    if (listFilter === ValueState.Information) {
      return message?.props?.type === ValueState.Information || message?.props?.type === ValueState.None;
    }
    return message?.props?.type === listFilter;
  });
  const groupedMessages = resolveMessageGroups(filteredChildren);
  const navigateBack = useCallback(() => {
    setSelectedMessage(null);
  }, [setSelectedMessage]);
  useEffect(() => {
    if (internalRef.current) {
      internalRef.current.navigateBack = navigateBack;
    }
  }, [internalRef.current, navigateBack]);
  const handleListFilterChange = e => {
    setListFilter(e.detail.selectedItem.dataset.key);
  };
  const outerClasses = clsx(classNames.container, GlobalStyleClasses.sapScrollBar, className, selectedMessage && classNames.showDetails);
  return /*#__PURE__*/React.createElement("div", {
    ref: componentRef,
    ...rest,
    className: outerClasses
  }, /*#__PURE__*/React.createElement(MessageViewContext.Provider, {
    value: {
      selectMessage: setSelectedMessage
    }
  }, /*#__PURE__*/React.createElement("div", {
    style: {
      visibility: selectedMessage ? 'hidden' : 'visible'
    },
    className: classNames.messagesContainer
  }, !selectedMessage && /*#__PURE__*/React.createElement(React.Fragment, null, filledTypes > 1 && /*#__PURE__*/React.createElement(Bar, {
    startContent: /*#__PURE__*/React.createElement(SegmentedButton, {
      onSelectionChange: handleListFilterChange
    }, /*#__PURE__*/React.createElement(SegmentedButtonItem, {
      "data-key": "All",
      pressed: listFilter === 'All'
    }, i18nBundle.getText(ALL)), Object.entries(messageTypes).map(([valueState, count]) => {
      if (count === 0) {
        return null;
      }
      return /*#__PURE__*/React.createElement(SegmentedButtonItem, {
        key: valueState,
        "data-key": valueState,
        pressed: listFilter === valueState,
        icon: getIconNameForType(valueState),
        className: classNames.button
      }, count);
    }))
  }), /*#__PURE__*/React.createElement(List, {
    onItemClick: onItemSelect,
    noDataText: i18nBundle.getText(LIST_NO_DATA)
  }, groupItems ? groupedMessages.map(([groupName, items]) => {
    return /*#__PURE__*/React.createElement(Fragment, {
      key: groupName
    }, groupName && /*#__PURE__*/React.createElement(GroupHeaderListItem, null, groupName), items);
  }) : filteredChildren))), /*#__PURE__*/React.createElement("div", {
    className: classNames.detailsContainer
  }, childrenArray.length > 0 ? /*#__PURE__*/React.createElement(React.Fragment, null, showDetailsPageHeader && selectedMessage && /*#__PURE__*/React.createElement(Bar, {
    startContent: /*#__PURE__*/React.createElement(Button, {
      design: ButtonDesign.Transparent,
      icon: iconSlimArrowLeft,
      onClick: navigateBack
    })
  }), selectedMessage && /*#__PURE__*/React.createElement(FlexBox, {
    className: classNames.details
  }, /*#__PURE__*/React.createElement(Icon, {
    "data-type": selectedMessage.type,
    name: getIconNameForType(selectedMessage.type),
    className: classNames.detailsIcon
  }), /*#__PURE__*/React.createElement(FlexBox, {
    direction: FlexBoxDirection.Column,
    className: classNames.detailsTextContainer
  }, /*#__PURE__*/React.createElement(Title, {
    level: TitleLevel.H5,
    className: classNames.detailsTitle,
    wrappingType: WrappingType.Normal
  }, selectedMessage.titleText), /*#__PURE__*/React.createElement("div", {
    className: classNames.detailsText
  }, selectedMessage.children)))) : null)));
});
MessageView.displayName = 'MessageView';
export { MessageView };